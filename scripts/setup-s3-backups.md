# üóÑÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤ –≤ S3

## –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å S3 bucket

### –í–∞—Ä–∏–∞–Ω—Ç –ê: Yandex Object Storage (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ [Yandex Cloud Console](https://console.cloud.yandex.ru/)
2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π bucket:
   - –ò–º—è: `creatix-backups` (–∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ)
   - –ö–ª–∞—Å—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: "–•–æ–ª–æ–¥–Ω–æ–µ" (–¥–µ—à–µ–≤–ª–µ)
   - –î–æ—Å—Ç—É–ø: "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π"
3. –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç:
   - IAM ‚Üí –°–µ—Ä–≤–∏—Å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã ‚Üí –°–æ–∑–¥–∞—Ç—å
   - –†–æ–ª—å: `storage.editor`
4. –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞:
   - –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª—é—á–∞ (Access Key ID)
   - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (Secret Access Key)

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~0.50‚ÇΩ/GB/–º–µ—Å—è—Ü (—Ö–æ–ª–æ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ), ~100-200‚ÇΩ/–º–µ—Å—è—Ü –∑–∞ ~100-200GB

### –í–∞—Ä–∏–∞–Ω—Ç –ë: VK Cloud Solutions (Mail.ru Cloud)

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ [VK Cloud](https://mcs.mail.ru/)
2. Object Storage ‚Üí –°–æ–∑–¥–∞—Ç—å bucket
3. API Keys ‚Üí –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á
4. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Access Key –∏ Secret Key

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~1‚ÇΩ/GB/–º–µ—Å—è—Ü

### –í–∞—Ä–∏–∞–Ω—Ç –í: AWS S3 (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å–µ—Ä–≤–∏—Å)

1. [AWS Console](https://console.aws.amazon.com/)
2. S3 ‚Üí Create bucket
3. IAM ‚Üí Create access key

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $0.023/GB/–º–µ—Å—è—Ü (~2.3‚ÇΩ/GB)

---

## –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å AWS CLI –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
ssh root@45.129.128.121

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å AWS CLI
apt-get update
apt-get install -y awscli

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É
aws --version
```

---

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å –∫—Ä–µ–¥–µ–Ω—à–∞–ª–∞–º–∏ S3
cat > /root/.s3-credentials << 'EOF'
export S3_ACCESS_KEY="YOUR_ACCESS_KEY_HERE"
export S3_SECRET_KEY="YOUR_SECRET_KEY_HERE"
export S3_BUCKET="creatix-backups"
export S3_ENDPOINT="https://storage.yandexcloud.net"  # –î–ª—è Yandex
# export S3_ENDPOINT="https://hb.bizmrg.com"  # –î–ª—è VK Cloud
# export S3_ENDPOINT="https://s3.amazonaws.com"  # –î–ª—è AWS
EOF

# –ó–∞—â–∏—Ç–∏—Ç—å —Ñ–∞–π–ª
chmod 600 /root/.s3-credentials

# –î–æ–±–∞–≤–∏—Ç—å –≤ ~/.bashrc
echo "source /root/.s3-credentials" >> ~/.bashrc
source ~/.bashrc
```

---

## –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä

–°–∫—Ä–∏–ø—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ: `scripts/backup-to-s3.sh`

```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp scripts/backup-to-s3.sh root@45.129.128.121:/root/backup-to-s3.sh

# –î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
ssh root@45.129.128.121 "chmod +x /root/backup-to-s3.sh"
```

---

## –®–∞–≥ 5: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É

```bash
ssh root@45.129.128.121

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫—Ä–µ–¥–µ–Ω—à–∞–ª—ã
source /root/.s3-credentials

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç
/root/backup-to-s3.sh
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
[2025-10-29 12:00:00] üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ç–∫–∞–ø–æ–≤ –≤ S3
[2025-10-29 12:00:01] üì§ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±—ç–∫–∞–ø–æ–≤ –≤ S3...
[2025-10-29 12:00:02] üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º creatix_db_20251029_111917.sql.gz...
[2025-10-29 12:00:05] ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: creatix_db_20251029_111917.sql.gz
[2025-10-29 12:00:06] üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –∑–∞–≥—Ä—É–∂–µ–Ω–æ 1, –æ—à–∏–±–æ–∫ 0
[2025-10-29 12:00:07] üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞ –≤ S3...
[2025-10-29 12:00:08] ‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø: creatix_db_20251029_111917.sql.gz (—Ä–∞–∑–º–µ—Ä: 4567890 bytes)
[2025-10-29 12:00:09] ‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ
```

---

## –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ cron (–∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤, —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞)
ssh root@45.129.128.121 "(crontab -l 2>/dev/null; echo '30 */6 * * * source /root/.s3-credentials && /root/backup-to-s3.sh >> /root/backup-s3.log 2>&1') | crontab -"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron
ssh root@45.129.128.121 "crontab -l"
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
*/5 * * * * /root/activate-payments-cron.sh
0 */6 * * * /root/backup-db.sh >> /root/backup.log 2>&1
30 */6 * * * source /root/.s3-credentials && /root/backup-to-s3.sh >> /root/backup-s3.log 2>&1
```

---

## –®–∞–≥ 7: –û–±–Ω–æ–≤–∏—Ç—å deploy.sh –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3

–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –¥–æ–ª–∂–µ–Ω —Ç–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –±—ç–∫–∞–ø—ã –≤ S3:

```bash
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å deploy.sh, –¥–æ–±–∞–≤–∏–≤ –ø–æ—Å–ª–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞:
source /root/.s3-credentials && /root/backup-to-s3.sh
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ç–∫–∞–ø—ã –≤ S3:
```bash
source /root/.s3-credentials
aws s3 ls s3://$S3_BUCKET/ --endpoint-url $S3_ENDPOINT
```

### –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø –∏–∑ S3:
```bash
source /root/.s3-credentials
aws s3 cp s3://$S3_BUCKET/creatix_db_TIMESTAMP.sql.gz /tmp/ --endpoint-url $S3_ENDPOINT
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞ –≤ S3:
```bash
# –°–∫–∞—á–∞—Ç—å
source /root/.s3-credentials
aws s3 cp s3://$S3_BUCKET/creatix_db_TIMESTAMP.sql.gz /tmp/ --endpoint-url $S3_ENDPOINT

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
gunzip -c /tmp/creatix_db_TIMESTAMP.sql.gz | docker exec -i creatix-postgres psql -U postgres -d creatix_db

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
pm2 restart creatix
```

---

## üìä –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å

**–ü—Ä–∏ –æ–±—ä–µ–º–µ –±—ç–∫–∞–ø–æ–≤ ~5GB:**
- Yandex Object Storage (—Ö–æ–ª–æ–¥–Ω–æ–µ): ~50‚ÇΩ/–º–µ—Å—è—Ü
- VK Cloud Solutions: ~100‚ÇΩ/–º–µ—Å—è—Ü
- AWS S3: ~150‚ÇΩ/–º–µ—Å—è—Ü

**–ü—Ä–∏ –æ–±—ä–µ–º–µ –±—ç–∫–∞–ø–æ–≤ ~50GB:**
- Yandex Object Storage (—Ö–æ–ª–æ–¥–Ω–æ–µ): ~250‚ÇΩ/–º–µ—Å—è—Ü
- VK Cloud Solutions: ~500‚ÇΩ/–º–µ—Å—è—Ü
- AWS S3: ~1000‚ÇΩ/–º–µ—Å—è—Ü

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [ ] S3 bucket —Å–æ–∑–¥–∞–Ω
- [ ] –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—É—á–µ–Ω
- [ ] AWS CLI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –°–∫—Ä–∏–ø—Ç backup-to-s3.sh –∑–∞–≥—Ä—É–∂–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Cron –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏
- [ ] Deploy.sh –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –¢–µ—Å—Ç–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

---

## üÜò –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö

1. **–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É:**
   ```bash
   ssh root@45.129.128.121
   ```

2. **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã –≤ S3:**
   ```bash
   source /root/.s3-credentials
   aws s3 ls s3://$S3_BUCKET/ --endpoint-url $S3_ENDPOINT | sort
   ```

3. **–°–∫–∞—á–∞—Ç—å –Ω—É–∂–Ω—ã–π –±—ç–∫–∞–ø:**
   ```bash
   BACKUP_FILE="creatix_db_YYYYMMDD_HHMMSS.sql.gz"
   aws s3 cp "s3://$S3_BUCKET/$BACKUP_FILE" /tmp/ --endpoint-url $S3_ENDPOINT
   ```

4. **–°–û–ó–î–ê–¢–¨ –ë–≠–ö–ê–ü –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π):**
   ```bash
   /root/backup-db.sh
   ```

5. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞:**
   ```bash
   # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   pm2 stop creatix

   # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î
   gunzip -c /tmp/$BACKUP_FILE | docker exec -i creatix-postgres psql -U postgres -d creatix_db

   # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   pm2 restart creatix
   ```

6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:**
   ```bash
   docker exec creatix-postgres psql -U postgres -d creatix_db -c "SELECT COUNT(*) FROM \"User\";"
   ```
