# ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Tochka Bank API

## üìã –°—Ç–∞—Ç—É—Å

**JWT —Ç–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!** API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **501 Not Implemented**, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ API endpoint'—ã –Ω–∞–π–¥–µ–Ω—ã
- ‚ùå **–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥ –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω** –≤ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ –¢–æ—á–∫–∞ –ë–∞–Ω–∫–∞

## üéØ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã

### –®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥

1. –ó–∞–π–¥–∏—Ç–µ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫ –¢–æ—á–∫–∞: https://business.tochka.com
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **"–¢–æ—Ä–≥–æ–≤—ã–π —ç–∫–≤–∞–π—Ä–∏–Ω–≥"** –∏–ª–∏ **"–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥"**
3. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–¥–∫–ª—é—á–∏—Ç—å"**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞—è–≤–∫—É:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞**: Creatix AI Document Generator
   - **URL —Å–∞–π—Ç–∞**: https://aicreatix.ru
   - **–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥**: –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å AI
   - **–°—Ä–µ–¥–Ω–∏–π —á–µ–∫**: 300 —Ä—É–±–ª–µ–π
5. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è)

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞

–ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç:

```bash
node test-new-jwt.js
```

–ï—Å–ª–∏ —ç–∫–≤–∞–π—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω, –≤—ã —É–≤–∏–¥–∏—Ç–µ:
- ‚úÖ –°—Ç–∞—Ç—É—Å `REG`, `isActive: true`
- ‚úÖ –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è

## üì¶ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

### 1. –ü–æ–ª–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [lib/tochka.ts](lib/tochka.ts)

–í—Å–µ –º–µ—Ç–æ–¥—ã API —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

#### –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏
```typescript
import { createTochkaClient } from '@/lib/tochka'

const tochka = createTochkaClient()

// –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É
const payment = await tochka.createPayment({
  amount: 100,
  purpose: '–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏',
  paymentMode: ['card', 'sbp', 'tinkoff'],
  redirectUrl: 'https://aicreatix.ru/success',
  failRedirectUrl: 'https://aicreatix.ru/failure',
  consumerId: userId,
  ttl: 1440, // 24 —á–∞—Å–∞
})

console.log('–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞:', payment.paymentUrl)
```

#### –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å —á–µ–∫–æ–º
```typescript
const paymentWithReceipt = await tochka.createPaymentWithReceipt({
  amount: 1000,
  purpose: '–ü–æ–¥–ø–∏—Å–∫–∞ ADVANCED',
  paymentMode: ['card', 'sbp'],
  redirectUrl: 'https://aicreatix.ru/success',
  failRedirectUrl: 'https://aicreatix.ru/failure',
  client: {
    email: 'user@example.com',
  },
  items: [
    {
      name: '–ü–æ–¥–ø–∏—Å–∫–∞ ADVANCED –Ω–∞ 1 –º–µ—Å—è—Ü',
      amount: 1000,
      quantity: 1,
    },
  ],
})
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
```typescript
const status = await tochka.getPaymentInfo(operationId)
console.log('–°—Ç–∞—Ç—É—Å:', status.status)
```

#### –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
```typescript
await tochka.refundPayment(operationId, {
  amount: 1000,
  reason: '–í–æ–∑–≤—Ä–∞—Ç –ø–æ –∑–∞–ø—Ä–æ—Å—É –∫–ª–∏–µ–Ω—Ç–∞',
})
```

### 2. TypeScript —Ç–∏–ø—ã

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:
- `TochkaPaymentParams` - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞—Ç–µ–∂–∞
- `TochkaPaymentWithReceiptParams` - –ø–ª–∞—Ç–µ–∂ —Å —á–µ–∫–æ–º
- `TochkaPaymentResponse` - –æ—Ç–≤–µ—Ç –æ—Ç API
- `TochkaQRCodeParams` - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã QR-–∫–æ–¥–∞
- –ò –¥—Ä—É–≥–∏–µ...

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

OAuth —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ 401 (token expired)
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –¢–µ—Å—Ç —Å JWT —Ç–æ–∫–µ–Ω–æ–º
node test-new-jwt.js

# –¢–µ—Å—Ç OAuth
node test-tochka-oauth.js
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞

```
‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•! API –†–ê–ë–û–¢–ê–ï–¢! ‚úÖ‚úÖ‚úÖ

–û—Ç–≤–µ—Ç –æ—Ç API:
{
  "paymentId": "abc123...",
  "paymentUrl": "https://payform.tochka.com/...",
  "status": "CREATED",
  "expiresAt": "2025-01-22T12:00:00Z"
}

üîó –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å—Å—ã–ª–∫–∞:
https://payform.tochka.com/pay/...
```

## üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env.local

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ:

```env
# Tochka Bank API credentials
TOCHKA_API_URL=https://enter.tochka.com
TOCHKA_CUSTOMER_CODE=305208987

# JWT-–∫–ª—é—á –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
# Client ID: 9d8201ff7897e036c0b30a5f89744a89
TOCHKA_JWT_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
TOCHKA_CLIENT_ID=9d8201ff7897e036c0b30a5f89744a89
```

## üîó API Endpoint'—ã

–í—Å–µ endpoint'—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ñ–æ—Ä–º–∞—Ç: `/uapi/{service}/{version}/{path}`

**–ü—Ä–∏–º–µ—Ä—ã:**
- GET `/uapi/open_banking/v1/customers` - —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
- GET `/uapi/acquiring/v1/retailers` - —Å—Ç–∞—Ç—É—Å —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞
- POST `/uapi/acquiring/v1/payments` - —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- POST `/uapi/acquiring/v1/payments/with_receipt` - –ø–ª–∞—Ç–µ–∂ —Å —á–µ–∫–æ–º
- GET `/uapi/acquiring/v1/payments` - —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π
- GET `/uapi/acquiring/v1/payments/{id}` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ
- POST `/uapi/acquiring/v1/payments/{id}/refund` - –≤–æ–∑–≤—Ä–∞—Ç
- GET `/uapi/sbp/v1/qr-code/legal-entity/{id}` - QR-–∫–æ–¥—ã

## üöÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏

```typescript
// app/api/create-payment/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createTochkaClient } from '@/lib/tochka'
import { getServerSession } from 'next-auth'

export async function POST(req: NextRequest) {
  const session = await getServerSession()
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { planType, amount } = await req.json()

  const tochka = createTochkaClient()

  try {
    const payment = await tochka.createPaymentWithReceipt({
      amount,
      purpose: `–ü–æ–¥–ø–∏—Å–∫–∞ Creatix ${planType}`,
      paymentMode: ['card', 'sbp', 'tinkoff'],
      redirectUrl: `${process.env.NEXT_PUBLIC_APP_URL}/payment-success`,
      failRedirectUrl: `${process.env.NEXT_PUBLIC_APP_URL}/payment-failure`,
      consumerId: session.user.id,
      client: {
        email: session.user.email,
      },
      items: [
        {
          name: `–ü–æ–¥–ø–∏—Å–∫–∞ Creatix ${planType}`,
          amount,
          quantity: 1,
        },
      ],
      ttl: 1440, // 24 —á–∞—Å–∞
    })

    return NextResponse.json({
      success: true,
      paymentUrl: payment.paymentUrl,
      paymentId: payment.paymentId,
    })
  } catch (error) {
    console.error('Payment creation error:', error)
    return NextResponse.json(
      { error: 'Failed to create payment' },
      { status: 500 }
    )
  }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã

```typescript
// app/payment-success/page.tsx
'use client'

import { useEffect } from 'react'
import { useSearchParams } from 'next/navigation'

export default function PaymentSuccess() {
  const searchParams = useSearchParams()
  const paymentId = searchParams.get('paymentId')

  useEffect(() => {
    if (paymentId) {
      // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
      fetch('/api/confirm-payment', {
        method: 'POST',
        body: JSON.stringify({ paymentId }),
      })
    }
  }, [paymentId])

  return (
    <div>
      <h1>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
      <p>–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</p>
    </div>
  )
}
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–¢–æ—á–∫–∞ –ë–∞–Ω–∫:**
- –¢–µ–ª–µ—Ñ–æ–Ω: 8 800 500-05-70
- Email: support@tochka.com
- –ß–∞—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫–µ

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- –û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://developers.tochka.com/docs/tochka-api/
- –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏: https://developers.tochka.com/docs/tochka-api/api/rabota-s-platyozhnymi-ssylkami
- QR-–∫–æ–¥—ã –°–ë–ü: https://enter.tochka.com/doc/v2/redoc/tag/Servis-SBP:-Rabota-s-QR-kodami

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] JWT —Ç–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Tochka API —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [x] TypeScript —Ç–∏–ø—ã —Å–æ–∑–¥–∞–Ω—ã
- [x] –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –≥–æ—Ç–æ–≤—ã
- [x] .env.local –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] **–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω** ‚Üê –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ!
- [ ] –ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –ø—Ä–æ–≤–µ–¥–µ–Ω
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üéâ –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥:

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `node test-new-jwt.js`
2. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!
3. –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ 10‚ÇΩ
4. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
5. –ì–æ—Ç–æ–≤–æ! üöÄ

---

**–í—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å –≥–æ—Ç–æ–≤–∞! –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –¥–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞ –æ—Ç –±–∞–Ω–∫–∞.**
