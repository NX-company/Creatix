# IndexedDB Migration - Storage Upgrade

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- HTML —Å base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∑–∞–Ω–∏–º–∞–ª ~4-5 MB
- localStorage –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç ~5-10 MB
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–æ–ª—å—à–∏—Ö HTML –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ `QuotaExceededError: localStorage quota exceeded`
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –≤ PRO —Ä–µ–∂–∏–º–µ (DALL-E –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HD –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)

### –†–µ—à–µ–Ω–∏–µ
–ü–µ—Ä–µ–Ω–µ—Å–ª–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML –∏–∑ localStorage –≤ IndexedDB:

| Storage | –õ–∏–º–∏—Ç | –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è |
|---------|-------|--------------|
| **localStorage** | ~5-10 MB | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–æ–≤, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è |
| **IndexedDB** | ~50-100 MB | HTML —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ |

## üì¶ –ò–∑–º–µ–Ω–µ–Ω–∏—è

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- `lib/storage/indexedDB.ts` - —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å IndexedDB

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `lib/store.ts`:
  - –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `loadHTMLFromIndexedDB()`
  - `setHtmlPreview()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç HTML –≤ IndexedDB
  - `saveCurrentProject()` –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç HTML –≤ localStorage
  - `switchProject()` / `deleteProject()` –∑–∞–≥—Ä—É–∂–∞—é—Ç/—É–¥–∞–ª—è—é—Ç HTML –∏–∑ IndexedDB
  - –ú–∏–≥—Ä–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏ 4: —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö `htmlPreview` –∏ `htmlPreviews` –∏–∑ localStorage

- `lib/constants.ts`:
  - `STORAGE_VERSION` –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ `4`

- `app/page.tsx`:
  - –î–æ–±–∞–≤–ª–µ–Ω `useEffect` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ HTML –∏–∑ IndexedDB –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

- `app/api/dalle-generate/route.ts`:
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ `agent is not defined` (—É–∂–µ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ, —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞)

### –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
```json
"idb": "^7.1.1"
```

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ HTML
```typescript
// –ö–æ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π HTML
setHtmlPreview(html)
  ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ memory (state)
  ‚Üí –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ IndexedDB
  ‚Üí –ö–ª—é—á: `${projectId}-${docType}` (–Ω–∞–ø—Ä–∏–º–µ—Ä: "project-123-proposal")
```

### –ó–∞–≥—Ä—É–∑–∫–∞ HTML
```typescript
// –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
switchProject(id) / setDocType(type)
  ‚Üí –û—á–∏—â–∞–µ—Ç htmlPreview –≤ state
  ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç loadHTMLFromIndexedDB()
  ‚Üí –ó–∞–≥—Ä—É–∂–∞–µ—Ç HTML –∏–∑ IndexedDB –ø–æ –∫–ª—é—á—É `${projectId}-${docType}`
  ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç state
```

### –£–¥–∞–ª–µ–Ω–∏–µ HTML
```typescript
// –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
deleteProject(id)
  ‚Üí –£–¥–∞–ª—è–µ—Ç –≤—Å–µ HTML –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (proposal, invoice, email, etc.)
  ‚Üí –£–¥–∞–ª—è–µ—Ç –ø—Ä–æ–µ–∫—Ç –∏–∑ localStorage
  ‚Üí –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –ø—Ä–æ–µ–∫—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ HTML –∏–∑ IndexedDB
```

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞**: IndexedDB –ª–∏–º–∏—Ç ~50-100 MB –≤–º–µ—Å—Ç–æ ~5-10 MB localStorage
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π API, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≤–∏–¥–µ–æ –∏ –±–æ–ª—å—à–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤ –±—É–¥—É—â–µ–º
4. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

## üîß API —Ñ—É–Ω–∫—Ü–∏–∏

### `lib/storage/indexedDB.ts`

```typescript
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å HTML –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
await saveHTMLPreview(storageKey: string, html: string): Promise<void>

// –ó–∞–≥—Ä—É–∑–∏—Ç—å HTML –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
await getHTMLPreview(storageKey: string): Promise<string | null>

// –£–¥–∞–ª–∏—Ç—å HTML –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
await deleteHTMLPreview(storageKey: string): Promise<void>

// –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ IndexedDB
await clearAllData(): Promise<void>

// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
await getStorageStats(): Promise<{
  htmlCount: number
  imageCount: number
  estimatedSize: string
}>
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è**: –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –≤–µ—Ä—Å–∏—é 4
   - –°—Ç–∞—Ä—ã–µ `htmlPreview` –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ localStorage
   - HTML –ù–ï –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ IndexedDB (–Ω–æ–≤—ã–µ HTML –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ)

2. **–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ IndexedDB:
   ```javascript
   // –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
   import { clearAllData } from './lib/storage/indexedDB'
   await clearAllData()
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: –ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ IndexedDB:
   - –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)
   - –í–∫–ª–∞–¥–∫–∞ "Application" ‚Üí "IndexedDB" ‚Üí "nx-studio-db"
   - –†–∞–∑–¥–µ–ª "htmlPreviews" - –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ HTML

## üêõ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

1. **DALL-E –æ—à–∏–±–∫–∞ `agent is not defined`**:
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ `app/api/dalle-generate/route.ts`
   - –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ `agent` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º

2. **Iframe sandbox warning**:
   - –£–¥–∞–ª–µ–Ω `allow-same-origin` –∏–∑ sandbox (–æ—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ `allow-scripts allow-popups`)

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ:

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Free mode
2. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Advanced mode (—Å Flux –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ PRO mode (—Å DALL-E HD –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
4. ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (proposal ‚Üí email ‚Üí invoice)
5. ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏
6. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
7. ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - HTML –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –∏–∑ IndexedDB

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**: –°–æ—Ö—Ä–∞–Ω—è—Ç—å AI-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ IndexedDB –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç HTML
2. **–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º**: Service Worker –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: Backend API –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
4. **–ö–æ–º–ø—Ä–µ—Å—Å–∏—è**: –°–∂–∞—Ç–∏–µ HTML –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ IndexedDB (LZ-string)


