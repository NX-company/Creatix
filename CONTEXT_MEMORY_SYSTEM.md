# 🧠 Система памяти и контекста для AI агентов

## ✅ РЕАЛИЗОВАНО

Полная система памяти, которая позволяет агентам:
- 💬 Помнить историю диалога
- 📄 Видеть что они уже создали
- 🎯 Понимать на что указывает пользователь
- 🎨 Знать какие изображения сгенерировали
- 🔄 Очищать память при смене типа документа

---

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────┐
│              ZUSTAND STORE                       │
│  (глобальное состояние приложения)              │
├─────────────────────────────────────────────────┤
│  lastGeneratedContent: string                    │
│  ↑ JSON контент последнего документа            │
│                                                  │
│  lastGeneratedImages: Array<{slot, prompt}>     │
│  ↑ Информация о сгенерированных изображениях    │
│                                                  │
│  selectedElement: {selector, html, text}        │
│  ↑ Элемент на который навел пользователь        │
│                                                  │
│  messages: Message[]                             │
│  ↑ История диалога (последние 10)               │
└─────────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│           CHATPANEL COMPONENT                    │
│  (формирует контекст для агента)                │
├─────────────────────────────────────────────────┤
│  Собирает ПОЛНЫЙ ПРОМПТ:                        │
│                                                  │
│  1. 💬 История диалога (последние 10 сообщений) │
│  2. 📄 Текущий документ (lastGeneratedContent)  │
│  3. 🎨 Список AI изображений (prompts)          │
│  4. 🎯 Выделенный элемент (если есть)           │
│  5. 📝 Текущий запрос пользователя              │
└─────────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────┐
│            AI AGENT (ORCHESTRATOR)               │
│  Получает ВЕСЬ контекст и понимает:             │
│  - Что было раньше                               │
│  - Что создано сейчас                            │
│  - На что указал пользователь                    │
│  - Какие изображения есть                        │
└─────────────────────────────────────────────────┘
```

---

## 📦 Изменения в файлах

### **1. `lib/store.ts`**

#### Добавлены новые поля:
```typescript
type Store = {
  // ... existing fields
  
  lastGeneratedContent: string // JSON контент последнего документа
  setLastGeneratedContent: (content: string) => void
  
  lastGeneratedImages: Array<{ slot: number; prompt: string }>
  setLastGeneratedImages: (images: Array<{ slot: number; prompt: string }>) => void
}
```

#### Очистка при смене типа документа:
```typescript
setDocType: (type) => {
  set({ 
    docType: type,
    htmlPreview: previews[type] || '',
    messages: [], // ⭐ Очищаем историю
    lastGeneratedContent: '', // ⭐ Очищаем контент
    lastGeneratedImages: [], // ⭐ Очищаем изображения
    selectedElement: null, // ⭐ Снимаем выделение
  })
}
```

---

### **2. `components/ChatPanel.tsx`**

#### Формирование ПОЛНОГО контекста:

```typescript
// 💬 ИСТОРИЯ ДИАЛОГА
const conversationHistory = messages.slice(-10)
  .map(msg => `${msg.role === 'user' ? '👤' : '🤖'}: ${msg.content}`)
  .join('\n')

// 📄 ТЕКУЩИЙ ДОКУМЕНТ
const documentContext = lastGeneratedContent 
  ? `📄 ТЕКУЩИЙ ДОКУМЕНТ:\n${lastGeneratedContent.substring(0, 2000)}...`
  : ''

// 🎨 СГЕНЕРИРОВАННЫЕ ИЗОБРАЖЕНИЯ
const imagesContext = lastGeneratedImages.length > 0
  ? `🎨 AI ИЗОБРАЖЕНИЯ:\n${lastGeneratedImages.map((img, i) => 
      `${i+1}. "${img.prompt}"`).join('\n')}`
  : ''

// 🎯 ВЫДЕЛЕННЫЙ ЭЛЕМЕНТ
const selectedElementContext = selectedElement
  ? `🎯 ВЫДЕЛЕННЫЙ ЭЛЕМЕНТ:
     Тип: ${elementType}
     Селектор: ${selectedElement.selector}
     Текст: ${selectedElement.textContent}
     
     ⚠️ ВАЖНО: Пользователь говорит про ЭТОТ элемент!`
  : ''

const fullPrompt = `
  ${contentPrompt}
  ${historyContext}
  ${documentContext}
  ${imagesContext}
  ${selectedElementContext}
  
  📝 ТЕКУЩИЙ ЗАПРОС: ${userMsg}
`
```

#### Сохранение после генерации:

```typescript
const result = await generateDocumentWithMode({...})

// Сохраняем для следующих команд
setLastGeneratedContent(result.content)

if (result.generatedImages.length > 0) {
  setLastGeneratedImages(result.generatedImages.map(img => ({
    slot: img.slot,
    prompt: img.prompt
  })))
}

// Снимаем выделение после применения изменений
if (selectedElement) {
  setSelectedElement(null)
}
```

---

## 📊 Примеры работы

### **Пример 1: Выбор варианта лого** ✅

```
User: "создай 3 варианта лого огурца"

Agent генерирует:
  {
    "variants": [
      {"id": 1, "style": "минимализм"},
      {"id": 2, "style": "реализм"},
      {"id": 3, "style": "мультяшный"}
    ]
  }

Сохраняется в lastGeneratedContent ✅

─────────────────────────────────────

User: "мне нравится вариант 3"

Промпт агенту включает:
  💬 ИСТОРИЯ:
  👤 Пользователь: создай 3 варианта лого огурца
  🤖 Ассистент: ✅ Создано 3 варианта
  
  📄 ТЕКУЩИЙ ДОКУМЕНТ:
  {
    "variants": [
      {"id": 1, "style": "минимализм"},
      {"id": 2, "style": "реализм"},
      {"id": 3, "style": "мультяшный"} ← ЭТО
    ]
  }
  
  📝 ЗАПРОС: мне нравится вариант 3

Agent видит:
  - Были 3 варианта
  - Вариант 3 = мультяшный стиль
  - Пользователь выбрал его
  → Генерирует ТОЛЬКО этот вариант ✅
```

---

### **Пример 2: Изменение выделенного элемента** ✅

```
User: создал презентацию
User: наводит курсор на заголовок → selectedElement заполняется
User: "сделай это красным и крупнее"

Промпт агенту:
  💬 ИСТОРИЯ:
  👤: создай презентацию компании
  🤖: ✅ Создана презентация
  
  📄 ТЕКУЩИЙ ДОКУМЕНТ:
  <h1 class="title">Презентация компании</h1>
  <p>Контент...</p>
  
  🎯 ВЫДЕЛЕННЫЙ ЭЛЕМЕНТ:
  Тип: заголовок
  Селектор: h1.title
  Текст: "Презентация компании"
  HTML: <h1 class="title" style="font-size: 24px">...</h1>
  
  ⚠️ ВАЖНО: Пользователь говорит про ЭТОТ элемент!
  
  📝 ЗАПРОС: сделай это красным и крупнее

Agent понимает:
  - Выделен h1.title
  - "это" = этот заголовок
  - Нужно: color: red, font-size: увеличить
  → Применяет стили ТОЛЬКО к h1.title ✅
```

---

### **Пример 3: Изменение конкретного изображения** ✅

```
User: "создай презентацию"

Agent генерирует 3 изображения:
  lastGeneratedImages = [
    {slot: 0, prompt: "business logo"},
    {slot: 1, prompt: "office background"},
    {slot: 2, prompt: "team collaboration"}
  ]

─────────────────────────────────────

User: наводит на изображение 2
User: "поменяй это на огурец"

Промпт:
  🎨 AI ИЗОБРАЖЕНИЯ:
  1. "business logo"
  2. "office background" ← ВЫДЕЛЕНО
  3. "team collaboration"
  
  🎯 ВЫДЕЛЕННЫЙ ЭЛЕМЕНТ:
  Тип: изображение
  Селектор: img.slide-image-2
  
  📝 ЗАПРОС: поменяй это на огурец

Agent:
  - Видит что выделено изображение 2
  - "это" = office background
  - Генерирует новое: "cucumber themed background"
  - Заменяет только slot 2 ✅
```

---

### **Пример 4: Смена типа документа** 🔄

```
User: работает с "Логотип"
  История: 5 сообщений
  lastGeneratedContent: {...лого данные...}
  lastGeneratedImages: [3 варианта лого]

User: переключается на "Презентация" ▼

setDocType('presentation') вызывается:
  ✅ messages = []
  ✅ lastGeneratedContent = ''
  ✅ lastGeneratedImages = []
  ✅ selectedElement = null

User: "создай презентацию компании"

Промпт агенту:
  💬 ИСТОРИЯ: (пусто)
  📄 ДОКУМЕНТ: (пусто)
  🎨 ИЗОБРАЖЕНИЯ: (пусто)
  📝 ЗАПРОС: создай презентацию компании

Agent начинает с чистого листа ✅
Не путает с данными логотипа ✅
```

---

## 🎯 Поддерживаемые команды

### **С историей диалога:**
- ✅ "мне нравится вариант 3"
- ✅ "давай его"
- ✅ "сделай как в первом варианте"
- ✅ "верни как было"
- ✅ "поменяй заголовок на 'Топ'"

### **С выделенным элементом:**
- ✅ "поменяй это"
- ✅ "сделай красным"
- ✅ "увеличь размер"
- ✅ "убери это"
- ✅ "перепиши короче"
- ✅ "замени изображение на огурец"

### **С изображениями:**
- ✅ "поменяй картинку 2"
- ✅ "измени изображение на..."
- ✅ "сделай другой фон"
- ✅ "замени лого"

---

## 🔍 Логи в консоли

При генерации с контекстом вы увидите:

```
Формирую контекст для агента:
  💬 История: 3 сообщения
  📄 Документ: 1523 символа
  🎨 Изображения: 3 шт.
  🎯 Выделено: заголовок h1.title
  
📝 Отправляю промпт (4567 символов)
```

---

## 💡 Лучшие практики

### **1. Конкретные ссылки работают лучше:**
```
❌ "измени"         → что именно?
✅ "измени заголовок" → понятно

❌ "поменяй"        → что?
✅ "поменяй вариант 3" → ясно
```

### **2. Наводите курсор для точечных правок:**
```
✅ Навести на элемент → "сделай красным"
   Agent точно знает что менять
```

### **3. Используйте номера для изображений:**
```
✅ "поменяй картинку 2"
✅ "измени изображение 3 на огурец"
```

### **4. Смена типа = новый диалог:**
```
Логотип → Презентация = память очищается
Начинайте заново, не ссылайтесь на старое
```

---

## ⚙️ Настройки

### **Количество сообщений в истории:**
```typescript
// components/ChatPanel.tsx строка 232
const recentMessages = messages.slice(-10) // Изменить -10 на -20
```

### **Размер контекста документа:**
```typescript
// components/ChatPanel.tsx строка 249
const contentPreview = lastGeneratedContent.substring(0, 2000) // Больше = больше контекста
```

### **Отключить очистку при смене типа:**
```typescript
// lib/store.ts setDocType
// Закомментируйте строки очистки, если не нужно
```

---

## ✅ Готово!

Система полностью реализована и готова к использованию:

1. ✅ Агенты помнят историю диалога
2. ✅ Видят что создали
3. ✅ Понимают выделенные элементы
4. ✅ Знают про изображения
5. ✅ Очищают память при смене типа

**Протестируйте:**
1. Создайте документ
2. Скажите "мне нравится вариант 2"
3. Наведите на элемент и скажите "сделай это красным"
4. Переключите тип документа → память очистится

**Всё должно работать! 🚀**


