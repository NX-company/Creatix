# üè¶ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Tochka Bank API - –ì–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ

–í—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **501 Not Implemented**, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- ‚úÖ JWT —Ç–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- ‚úÖ API endpoints –Ω–∞–π–¥–µ–Ω—ã (`/uapi/`)
- ‚ùå **–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω** –≤ –¢–æ—á–∫–∞ –ë–∞–Ω–∫–µ

## üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞

### –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ–ª—É—á–∞–µ–º –æ—à–∏–±–∫—É **501 Not Implemented** –Ω–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ `/uapi/acquiring/*`

### –†–µ—à–µ–Ω–∏–µ

–í–∞–º –Ω—É–∂–Ω–æ **–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç–∫–≤–∞–π—Ä–∏–Ω–≥** –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫–µ –¢–æ—á–∫–∞:

1. **–ó–∞–π–¥–∏—Ç–µ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫**: https://business.tochka.com
2. **–ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "–≠–∫–≤–∞–π—Ä–∏–Ω–≥"** –∏–ª–∏ "–¢–æ—Ä–≥–æ–≤—ã–π —ç–∫–≤–∞–π—Ä–∏–Ω–≥"
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å**:
   - –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω" ‚Üí –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å"
   - –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏" ‚Üí –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è
   - –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–µ–Ω" ‚Üí —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π (—Ç–µ–ª: 8 800 500-05-70)

4. **–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —É–∫–∞–∂–∏—Ç–µ**:
   - –ù–∞–∑–≤–∞–Ω–∏–µ: Creatix AI Document Generator
   - –°–∞–π—Ç: https://aicreatix.ru
   - –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: 300‚ÇΩ
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

5. **–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–¥–æ–±—Ä–µ–Ω–∏—è** (–æ–±—ã—á–Ω–æ 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è)

6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É**:
   ```bash
   node test-latest-jwt.js
   ```

   –ï—Å–ª–∏ —É–≤–∏–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É - –≥–æ—Ç–æ–≤–æ! üéâ

## üì¶ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

### 1. –ü–æ–ª–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ API

–§–∞–π–ª: [lib/tochka.ts](lib/tochka.ts)

**–í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:**

```typescript
import { createTochkaClient } from '@/lib/tochka'

const tochka = createTochkaClient()

// –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É
const payment = await tochka.createPayment({
  amount: 1000,
  purpose: '–ü–æ–¥–ø–∏—Å–∫–∞ ADVANCED',
  paymentMode: ['card', 'sbp', 'tinkoff'],
  redirectUrl: 'https://aicreatix.ru/success',
  failRedirectUrl: 'https://aicreatix.ru/failure',
  consumerId: userId,
  ttl: 1440, // 24 —á–∞—Å–∞
})

console.log('–û–ø–ª–∞—Ç–∏—Ç–µ –∑–¥–µ—Å—å:', payment.paymentUrl)
```

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

#### –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏
- `createPayment(params)` - —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É
- `createPaymentWithReceipt(params)` - —Å–æ–∑–¥–∞—Ç—å —Å —á–µ–∫–æ–º
- `getPaymentList(params)` - —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π
- `getPaymentInfo(operationId)` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ
- `refundPayment(operationId, params)` - –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
- `capturePayment(operationId, amount)` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- `getPaymentRegistry(from, to)` - —Ä–µ–µ—Å—Ç—Ä –ø–ª–∞—Ç–µ–∂–µ–π

#### QR-–∫–æ–¥—ã –°–ë–ü
- `getQRCodesList(legalId)` - —Å–ø–∏—Å–æ–∫ QR-–∫–æ–¥–æ–≤
- `getQRCode(qrcId)` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ QR-–∫–æ–¥–µ
- `registerQRCode(merchantId, accountId, params)` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `getQRCodesPaymentStatus(qrcIds)` - —Å—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π

#### –ö–ª–∏–µ–Ω—Ç—ã –∏ —ç–∫–≤–∞–π—Ä–∏–Ω–≥
- `getCustomersList()` - —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
- `getCustomerInfo(customerCode)` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ
- `getRetailers()` - —Å—Ç–∞—Ç—É—Å —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞

### 2. TypeScript —Ç–∏–ø—ã

–ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤:
- `TochkaPaymentParams`
- `TochkaPaymentWithReceiptParams`
- `TochkaPaymentResponse`
- `TochkaQRCodeParams`
- `TochkaQRCodeResponse`
- –ò –¥—Ä—É–≥–∏–µ...

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–§–∞–π–ª: [.env.local](.env.local)

```env
TOCHKA_API_URL=https://enter.tochka.com
TOCHKA_CUSTOMER_CODE=305208987
TOCHKA_JWT_TOKEN=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
TOCHKA_CLIENT_ID=feb5d00f45315570c01efd41d90d8859
```

### 4. –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

- `test-latest-jwt.js` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç
- `test-tochka-oauth.js` - —Ç–µ—Å—Ç OAuth
- `test-different-urls.js` - –ø–æ–∏—Å–∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö URL

### 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `README_TOCHKA.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª
- `TOCHKA_FINAL_SETUP.md` - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `TOCHKA_API_STATUS.md` - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞

```bash
node test-latest-jwt.js
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–ï–ô–ß–ê–° (—ç–∫–≤–∞–π—Ä–∏–Ω–≥ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω)

```
üîÑ –°—Ç–∞—Ç—É—Å: 501 Not Implemented
‚ùå –û—à–∏–±–∫–∞: {"code":"501","message":"–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫"}
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ü–û–°–õ–ï –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

```
‚úÖ‚úÖ‚úÖ –£–°–ü–ï–•! API –†–ê–ë–û–¢–ê–ï–¢! ‚úÖ‚úÖ‚úÖ

üì¶ –û—Ç–≤–µ—Ç –æ—Ç API:
{
  "paymentId": "abc123...",
  "paymentUrl": "https://payform.tochka.com/...",
  "status": "CREATED"
}

üîóüîóüîó –ü–õ–ê–¢–ï–ñ–ù–ê–Ø –°–°–´–õ–ö–ê:
https://payform.tochka.com/pay/...
```

## üíª –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏

```typescript
// app/api/payments/create/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createTochkaClient } from '@/lib/tochka'
import { getServerSession } from 'next-auth'

export async function POST(req: NextRequest) {
  const session = await getServerSession()
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { planType, amount } = await req.json()
  const tochka = createTochkaClient()

  try {
    const payment = await tochka.createPaymentWithReceipt({
      amount,
      purpose: `–ü–æ–¥–ø–∏—Å–∫–∞ Creatix ${planType}`,
      paymentMode: ['card', 'sbp', 'tinkoff'],
      redirectUrl: `https://aicreatix.ru/payment/success?plan=${planType}`,
      failRedirectUrl: `https://aicreatix.ru/payment/failure`,
      consumerId: session.user.id,
      client: {
        email: session.user.email!,
      },
      items: [
        {
          name: `–ü–æ–¥–ø–∏—Å–∫–∞ Creatix ${planType}`,
          amount,
          quantity: 1,
        },
      ],
    })

    return NextResponse.json({
      success: true,
      paymentUrl: payment.paymentUrl,
      paymentId: payment.paymentId,
    })
  } catch (error) {
    console.error('Payment error:', error)
    return NextResponse.json(
      { error: 'Failed to create payment' },
      { status: 500 }
    )
  }
}
```

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã

```typescript
// app/payment/success/page.tsx
'use client'

import { useEffect } from 'react'
import { useSearchParams, useRouter } from 'next/navigation'

export default function PaymentSuccess() {
  const searchParams = useSearchParams()
  const router = useRouter()
  const plan = searchParams.get('plan')

  useEffect(() => {
    // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    fetch('/api/user/upgrade', {
      method: 'POST',
      body: JSON.stringify({ plan }),
      headers: { 'Content-Type': 'application/json' },
    }).then(() => {
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => router.push('/'), 3000)
    })
  }, [plan, router])

  return (
    <div className="container mx-auto p-8 text-center">
      <h1 className="text-3xl font-bold text-green-600 mb-4">
        ‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
      </h1>
      <p className="text-lg mb-4">
        –ü–æ–¥–ø–∏—Å–∫–∞ {plan} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
      </p>
      <p className="text-gray-600">
        –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É...
      </p>
    </div>
  )
}
```

## üìã API Endpoints

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞: `https://enter.tochka.com/uapi/{service}/{version}/{path}`

### –ü—Ä–∏–º–µ—Ä—ã:

```
GET  /uapi/open_banking/v1/customers
GET  /uapi/acquiring/v1/retailers
POST /uapi/acquiring/v1/payments
POST /uapi/acquiring/v1/payments/with_receipt
GET  /uapi/acquiring/v1/payments
GET  /uapi/acquiring/v1/payments/{id}
POST /uapi/acquiring/v1/payments/{id}/refund
POST /uapi/acquiring/v1/payments/{id}/capture
GET  /uapi/acquiring/v1/registry
GET  /uapi/sbp/v1/qr-code/legal-entity/{id}
POST /uapi/sbp/v1/qr-code/merchant/{mid}/account/{aid}
GET  /uapi/sbp/v1/qr-codes/{ids}/payment-status
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

JWT —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ:
```
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 401 (expired token)
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏
- Retry –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞

### OAuth –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å—Ç—å –º–µ—Ç–æ–¥ `getOAuthToken()` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ Client Credentials flow (–Ω–∞ –±—É–¥—É—â–µ–µ).

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–¢–æ—á–∫–∞ –ë–∞–Ω–∫:**
- ‚òéÔ∏è 8 800 500-05-70
- üìß support@tochka.com
- üí¨ –ß–∞—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–±–∞–Ω–∫–µ

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- üìñ https://developers.tochka.com/docs/tochka-api/
- üí≥ https://developers.tochka.com/docs/tochka-api/api/rabota-s-platyozhnymi-ssylkami
- üì± https://enter.tochka.com/doc/v2/redoc/tag/Servis-SBP:-Rabota-s-QR-kodami

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] JWT —Ç–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [x] API –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
- [x] TypeScript —Ç–∏–ø—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [x] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞
- [ ] **–≠–∫–≤–∞–π—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω** ‚Üê –§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥!
- [ ] –ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –ø—Ä–æ–≤–µ–¥–µ–Ω
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## üéâ –ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: `node test-latest-jwt.js`
2. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Å—ã–ª–∫—É - **–í–°–Å –†–ê–ë–û–¢–ê–ï–¢!** üöÄ
3. –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ 10‚ÇΩ
4. –í–Ω–µ–¥—Ä—è–π—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
5. Profit! üí∞

---

**üí° –í—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç–∫–≤–∞–π—Ä–∏–Ω–≥ –≤ –±–∞–Ω–∫–µ!**

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞.**
