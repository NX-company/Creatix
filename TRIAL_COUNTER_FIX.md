# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞

## –ü—Ä–æ–±–ª–µ–º–∞
–°—á–µ—Ç—á–∏–∫ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª 30/30 –∏ –Ω–µ —É–º–µ–Ω—å—à–∞–ª—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏

### 1. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ª–∏–º–∏—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π**
- **–§–∞–π–ª:** `app/api/user/increment-trial-generation/route.ts`
- **–ü—Ä–æ–±–ª–µ–º–∞:** API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ª–∏–º–∏—Ç 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –∞ UI –ø–æ–∫–∞–∑—ã–≤–∞–ª 30
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–π –ª–∏–º–∏—Ç `TRIAL_LIMIT = 30`

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ API**
- **–§–∞–π–ª:** `app/api/user/increment-trial-generation/route.ts`  
- **–ü—Ä–æ–±–ª–µ–º–∞:** API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª custom JWT auth (`getUserFromRequest`), –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å NextAuth session
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ `getServerSession(authOptions)` –∏–∑ NextAuth

### 3. **–ù–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω authOptions**
- **–§–∞–π–ª:** `app/api/auth/[...nextauth]/route.ts`
- **–ü—Ä–æ–±–ª–µ–º–∞:** `authOptions` –±—ã–ª –æ–±—ä—è–≤–ª–µ–Ω –∫–∞–∫ `const` –≤–º–µ—Å—Ç–æ `export const`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ API endpoints, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ `authOptions`, –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω `export`

### 4. **Session –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø–æ—Å–ª–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞**
- **–§–∞–π–ª:** `app/api/auth/[...nextauth]/route.ts` (JWT callback)
- **–ü—Ä–æ–±–ª–µ–º–∞:** JWT callback –æ–±–Ω–æ–≤–ª—è–ª token —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –ë–î –ø—Ä–∏ `trigger === 'update'`

### 5. **UI –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**
- **–§–∞–π–ª—ã:** `components/ChatPanel.tsx`, `components/Sidebar.tsx`
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ —Å—á–µ—Ç—á–∏–∫ –≤ Sidebar –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 
  - –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ `trialGenerationConsumed` –≤ ChatPanel
  - –î–æ–±–∞–≤–ª–µ–Ω listener –≤ Sidebar —Å –≤—ã–∑–æ–≤–æ–º `updateSession()`

## –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### ‚úÖ `app/api/user/increment-trial-generation/route.ts`
```typescript
- –ò–∑–º–µ–Ω–µ–Ω –ª–∏–º–∏—Ç —Å 3 –Ω–∞ 30 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
- –ü–µ—Ä–µ—Ö–æ–¥ —Å getUserFromRequest –Ω–∞ getServerSession
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç authOptions
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### ‚úÖ `app/api/auth/[...nextauth]/route.ts`
```typescript
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω authOptions
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è JWT token –∏–∑ –ë–î –ø—Ä–∏ trigger === 'update'
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è token
```

### ‚úÖ `components/ChatPanel.tsx`
```typescript
- –¢—Ä–∏–≥–≥–µ—Ä —Å–æ–±—ã—Ç–∏—è trialGenerationConsumed –ø–æ—Å–ª–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Ä–æ–≥–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π (3 -> 5)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ trialLimit –≤ —Å–æ–±—ã—Ç–∏–µ
```

### ‚úÖ `components/Sidebar.tsx`
```typescript
- –î–æ–±–∞–≤–ª–µ–Ω listener –Ω–∞ —Å–æ–±—ã—Ç–∏–µ trialGenerationConsumed
- –í—ã–∑–æ–≤ updateSession() –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è NextAuth session
- Fallback –Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç**
2. ChatPanel –≤—ã–∑—ã–≤–∞–µ—Ç `/api/user/increment-trial-generation`
3. API –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç `trialGenerations` –≤ –ë–î
4. ChatPanel —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç —Å–æ–±—ã—Ç–∏–µ `trialGenerationConsumed`
5. Sidebar –ª–æ–≤–∏—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `updateSession()`
6. NextAuth JWT callback –ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
7. Session –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
8. UI –≤ Sidebar –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –°—á–µ—Ç—á–∏–∫ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å 30 –¥–æ 0  
‚úÖ UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏  
‚úÖ –í—Å–µ API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ NextAuth session —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –ë–î  
‚úÖ –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è trial –Ω–∞ 3 –¥–Ω—è  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã debug –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å `trialEndsAt = null`, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∏—Ö "–Ω–µ –≤ trial".

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: `http://localhost:3000/debug-trial`
–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏:
```javascript
fetch('/api/admin/fix-trial-users', { method: 'POST' })
  .then(r => r.json())
  .then(console.log)
```

### –†—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Prisma Studio:
```bash
npx prisma studio
```
–û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É User –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
- `trialEndsAt` = –¥–∞—Ç–∞ —á–µ—Ä–µ–∑ 3 –¥–Ω—è –æ—Ç —Å–µ–≥–æ–¥–Ω—è
- `trialGenerations` = 0

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:
1. –û—Ç–∫—Ä–æ–π—Ç–µ: `http://localhost:3000/debug-trial`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `isInTrial = true`
3. –ï—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø—Ä–∞–≤—å—Ç–µ —á–µ—Ä–µ–∑ endpoint –≤—ã—à–µ

### –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
1. –í–æ–π—Ç–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ–±–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ
2. –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
3. –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (–∫–æ–º–∞–Ω–¥–∞ "—Å–¥–µ–ª–∞–π –∫–ø")
4. –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:
   - `üë§ Current user initialized: { isInTrial: true }`
   - `üéØ Trial user detected, incrementing...`
   - `‚úÖ Trial generation counted. Remaining: 29/30`
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—á–µ—Ç—á–∏–∫ —É–º–µ–Ω—å—à–∏–ª—Å—è (29/30)
6. –°–æ–∑–¥–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—á–µ—Ç—á–∏–∫ —Å–Ω–æ–≤–∞ —É–º–µ–Ω—å—à–∏–ª—Å—è (28/30)

## Debug –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

üìÑ **–ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** `TRIAL_COUNTER_DEBUG.md`  
üîß **Debug —Å—Ç—Ä–∞–Ω–∏—Ü–∞:** `http://localhost:3000/debug-trial`  
üîç **API endpoint:** `GET /api/debug/check-user`

---

**–î–∞—Ç–∞:** 16 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

