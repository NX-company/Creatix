# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –ª–∏–º–∏—Ç–∞ –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

## –ü—Ä–æ–±–ª–µ–º—ã
1. **–î—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ** - –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–ª—è–ª–æ—Å—å –¥–≤–∞–∂–¥—ã
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≥–æ—Å—Ç–µ–≤–æ–π –ª–∏–º–∏—Ç** - –±—ã–ª–æ 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 1

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **–ò–∑–º–µ–Ω–µ–Ω –≥–æ—Å—Ç–µ–≤–æ–π –ª–∏–º–∏—Ç —Å 3 –Ω–∞ 1**

**–§–∞–π–ª—ã:**
- `lib/guestGenerations.ts` - `GUEST_LIMIT = 1`
- `lib/store.ts` - `guestGenerationsLimit: 1`

**–ë—ã–ª–æ:** –ì–æ—Å—Ç—å –ø–æ–ª—É—á–∞–ª 3 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏  
**–°—Ç–∞–ª–æ:** –ì–æ—Å—Ç—å –ø–æ–ª—É—á–∞–µ—Ç 1 –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π**

**–§–∞–π–ª:** `components/ChatPanel.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:** 
–ü—Ä–∏ –∫–∞–∂–¥–æ–º progress callback –∏–∑ orchestrator –¥–æ–±–∞–≤–ª—è–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –µ—Å–ª–∏ orchestrator –≤—ã–∑—ã–≤–∞–ª—Å—è –¥–≤–∞–∂–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä –≤ React StrictMode), —Å–æ–æ–±—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**

#### A. Set –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
```typescript
const shownProgressMessages = useRef<Set<string>>(new Set())

// –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
shownProgressMessages.current.clear()

// –í onProgress callback
onProgress: (message: string) => {
  // Use Set to track shown messages and prevent duplicates completely
  if (!shownProgressMessages.current.has(message)) {
    shownProgressMessages.current.add(message)
    addMessage({ role: 'assistant', content: message })
    console.log('‚úÖ Progress:', message.substring(0, 60) + '...')
  } else {
    console.log('‚è≠Ô∏è Skipping duplicate progress:', message.substring(0, 60) + '...')
  }
}
```

#### B. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ auto-generation (useRef):
```typescript
const hasTriggeredAutoGen = useRef(false) // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–∞–º–∏

useEffect(() => {
  const handleAutoGeneration = (event: Event) => {
    if (hasTriggeredAutoGen.current) {
      console.log('‚è≠Ô∏è Auto-generation already triggered, ignoring duplicate event')
      return
    }
    
    if (prompt && !isGeneratingRef.current && !loading && !hasTriggeredAutoGen.current) {
      hasTriggeredAutoGen.current = true
      // ... trigger generation
    }
  }
  // ...
}, [loading, triggerGeneration])
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `useRef` –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π! –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–µ, —á—Ç–æ –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.

#### C. –†–∞–Ω–Ω—è—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –≤ handleRun:
```typescript
const handleRun = async () => {
  if (!input.trim() || loading) return
  
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –°–†–ê–ó–£ –ø–æ—Å–ª–µ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition)
  if (isGeneratingRef.current) {
    console.log('‚ùå handleRun blocked: generation already in progress')
    return
  }
  isGeneratingRef.current = true // ‚Üê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û!
  
  // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞...
}
```

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –§–ª–∞–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –î–û –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –∏–Ω–∞—á–µ –≤—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –º–æ–∂–µ—Ç –ø—Ä–æ—Å–∫–æ—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- Set –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–±–∞–≤–∏—Ç—Å—è –¥–≤–∞–∂–¥—ã
- useRef –¥–ª—è hasTriggeredAutoGen –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ auto-generation –º–µ–∂–¥—É —Ä–µ-—Ä–µ–Ω–¥–µ—Ä–∞–º–∏
- –†–∞–Ω–Ω—è—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ isGeneratingRef –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –≤ async —Ñ—É–Ω–∫—Ü–∏–∏
- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –¥–∞–∂–µ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ä–µ–Ω–¥–µ—Ä–µ –≤ StrictMode

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –¥–ª—è –≥–æ—Å—Ç—è**

**–§–∞–π–ª:** `components/ChatPanel.tsx`

**–ë—ã–ª–æ:**
- –ü–µ—Ä–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–∏–∑ welcome): –ù–ï —Å—á–∏—Ç–∞–ª–∞—Å—å, —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å –º–æ–¥–∞–ª–∫–∞
- –ì–æ—Å—Ç—å –º–æ–≥ —Å–¥–µ–ª–∞—Ç—å –µ—â–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–°—Ç–∞–ª–æ:**
- –ü–µ—Ä–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–∏–∑ welcome): –°–ß–ò–¢–ê–ï–¢–°–Ø –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è (1/1)
- –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ì–æ—Å—Ç—å –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å (0/1)

**–õ–æ–≥–∏–∫–∞:**
```typescript
if (wasFirstGeneration) {
  // Remove flag and switch to FREE mode
  sessionStorage.removeItem('first_generation_advanced')
  useStore.setState({ appMode: 'free' })
  
  // Increment guest counter for first demo generation (counts as used)
  incrementGuestGenerations()
  
  console.log('‚úÖ First generation used (1/1). Limit reached.')
  
  // Show welcome upgrade modal after 1.5 seconds
  setTimeout(() => {
    setShowWelcomeUpgradeModal(true)
  }, 1500)
}
```

### 4. **–û–±–Ω–æ–≤–ª–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è**

**–ë—ã–ª–æ:**
```
‚ö° –£ –≤–∞—Å –æ—Å—Ç–∞–ª–∞—Å—å 1 –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
‚ö° –≠—Ç–æ –±—ã–ª–∞ –≤–∞—à–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```

**–°—Ç–∞–ª–æ:**
```
‚ö° –≠—Ç–æ –±—ã–ª–∞ –≤–∞—à–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è! –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å 30 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –º–µ—Å—è—Ü.
```

## üéØ User Flow —Ç–µ–ø–µ—Ä—å:

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–µ—Ä–≤—ã–π –≤–∏–∑–∏—Ç –≥–æ—Å—Ç—è

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `/welcome`
2. –í–≤–æ–¥–∏—Ç –ø—Ä–æ–º–ø—Ç –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å"
3. **–°—á–µ—Ç—á–∏–∫ –≤ —Å–∞–π–¥–±–∞—Ä–µ:** `1/1` (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é)
4. –°–æ–∑–¥–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç
5. **–í –∫–æ–Ω—Å–æ–ª–∏:** `‚úÖ First generation used (1/1). Limit reached.`
6. **–°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:** `0/1`
7. –ß–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞:
   - –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞: FREE –∏–ª–∏ ADVANCED
   - –ö–Ω–æ–ø–∫–∏: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ" –∏–ª–∏ "–ö—É–ø–∏—Ç—å –∑–∞ 1000‚ÇΩ/–º–µ—Å"
8. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–ª–∞–Ω–∞ - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `/register?plan=...`

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–ø—ã—Ç–∫–∞ –≤—Ç–æ—Ä–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

1. –ì–æ—Å—Ç—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
2. –°—á–µ—Ç—á–∏–∫: `0/1`
3. –ü—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –µ—â–µ –¥–æ–∫—É–º–µ–Ω—Ç
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ: `üö´ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!`
5. –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
6. –ú–æ–¥–∞–ª–∫–∞ `GenerationLimitModal`

## üìä –°—á–µ—Ç—á–∏–∫ –≤ Sidebar

**–ë—ã–ª–æ:** `3/3` ‚Üí `2/3` ‚Üí `1/3` ‚Üí `0/3`  
**–°—Ç–∞–ª–æ:** `1/1` ‚Üí `0/1`

–í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä:
```
üé≠ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
‚ö° –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

0/1           –æ—Å—Ç–∞–ª–æ—Å—å
[======|          ] –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (0%)

–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å!
```

## üîç Debug –ª–æ–≥–∏

### –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
```
üéÅ First ADVANCED generation complete! Switching to FREE mode
‚úÖ First generation used (1/1). Limit reached.
```

### –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Ç–æ—Ä–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:
```
üö´ Guest limit reached: 0 remaining
```

### –ü—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:
```
üìã Progress message already in chat, skipping duplicate: –ü–ª–∞–Ω–∏—Ä—É—é AI –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞...
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

1. ‚úÖ –ì–æ—Å—Ç–µ–≤–æ–π –ª–∏–º–∏—Ç: **1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** –≤–º–µ—Å—Ç–æ 3
2. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ **–Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è**
3. ‚úÖ –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ **—Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞** —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
4. ‚úÖ –°—á–µ—Ç—á–∏–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **1/1 ‚Üí 0/1**
5. ‚úÖ –£–ª—É—á—à–µ–Ω UX - –ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è

---

**–î–∞—Ç–∞:** 16 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

